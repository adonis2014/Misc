1. PUT blob (in EI)
[yinzhang@lca1-app0680 ~]$ curl -i -H "x-ambry-target-account-name:ambry-internal-store" -H "x-ambry-target-container-name:shared-files" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:yinzhang" -H "x-ambry-content-type:text/csv" -H "x-ambry-um-description:gaap-online-tasks-misplaced-blobs" -H "x-li-ambry-client:Internal" http://lca1-app0680.stg.linkedin.com:15158 --data-binary @gaap-online-tasks.csv

HTTP/1.1 201 Created
Location: /AAMAAQQMAAkAAQAAAAAAAACYAAAAJGFkOWZhODkzLTc4ODAtNGJlZi1iYzdkLTg3ODZiNGI4ODM2NA.csv
Date: Thu, 01 Mar 2018 00:31:51 GMT
Content-Length: 0
x-ambry-creation-time: Thu, 01 Mar 2018 00:31:33 GMT
Access-Control-Expose-Headers: Location

#----------------------------------------------------------------------------------------------------------------------------#

2. PUT blob (in PROD)
[yinzhang@lva1-app18926 ~]$ curl -i -H "x-ambry-target-account-name:ambry-internal-store" -H "x-ambry-target-container-name:shared-files" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:yinzhang" -H "x-ambry-content-type:text/csv" -H "x-li-ambry-client:Internal" http://lva1-app18926.prod.linkedin.com:15158 --data-binary @test.csv

HTTP/1.1 201 Created
Location: /AAMAAgQfAAkAAQAAAAAAAAzaAAAAJGViZDk4YWI1LWYwMDItNDZlYi05MGE1LTc3ZmEwOWVjNGJiMA.csv
Date: Fri, 16 Mar 2018 21:52:58 GMT
Content-Length: 0
x-ambry-creation-time: Fri, 16 Mar 2018 21:52:56 GMT
Access-Control-Expose-Headers: Location

#----------------------------------------------------------------------------------------------------------------------------#

3. DELETE blob (in PROD)
[yinzhang@lva1-app18926 ~]$ curl -i -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app18926.prod.linkedin.com:15158/ambry/AAMAAgQfAAkAAQAAAAAAAAzaAAAAJGViZDk4YWI1LWYwMDItNDZlYi05MGE1LTc3ZmEwOWVjNGJiMA.csv

HTTP/1.1 202 Accepted
Date: Fri, 16 Mar 2018 21:55:17 GMT
Content-Length: 0

#----------------------------------------------------------------------------------------------------------------------------#

4. DELETE blob (in EI)
curli -i -H "x-li-ambry-client:Internal" -X DELETE d2://ambry/AAMAAQQMAAkAAQAAAAAAAADPAAAAJDE2NjZhNzI4LWNiZmQtNDdkNC1iZTUwLWVhN2E1NzlmZjQzYw.csv

[INFO] Current profile set to default: yinzhang-mn1.linkedin.biz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 202 Accepted
Date: Thu, 01 Mar 2018 22:43:12 GMT
Content-Length: 0

#----------------------------------------------------------------------------------------------------------------------------#

5. GET blob (in EI)
curli -s --no-log --fabric ei-ltx1 -i -H "x-li-ambry-client:Internal" d2://ambry/AAMA______8AAQAAAAAAAAAAAAAAJDlkNGRlMTEzLTE5MWItNDA5MC05OGUzLTQ1ZWYzY2Y4MTE2ZQ.bin

[INFO] Current profile set to default: yinzhang-mn1.linkedin.biz
HTTP/1.1 404 Not Found
Content-Type: text/plain;charset=utf-8
Date: Thu, 01 Mar 2018 21:40:36 GMT
x-ambry-error-code: NotFound
Content-Length: 0

#----------------------------------------------------------------------------------------------------------------------------#

6. GET blob (in PROD)
[yinzhang@lva1-app18926 ~]$ curl -s -i -H "x-li-ambry-client:Internal" http://lva1-app18926.prod.linkedin.com:15158/AAMA______8AAQAAAAAAAAAAAAAAJDlkNGRlMTEzLTE5MWItNDA5MC05OGUzLTQ1ZWYzY2Y4MTE2ZQ.bin

HTTP/1.1 404 Not Found
date: Fri, 16 Mar 2018 21:17:33 GMT
content-length: 0
x-ambry-error-code: NotFound
content-type: text/plain; charset=UTF-8

#----------------------------------------------------------------------------------------------------------------------------#

7. GET blobInfo (in EI)
curli -s --no-log --fabric ei-ltx1 -I -H "x-li-ambry-client:Internal" d2://ambry/AAMA______8AAQAAAAAAAAAAAAAAJDlkNGRlMTEzLTE5MWItNDA5MC05OGUzLTQ1ZWYzY2Y4MTE2ZQ.bin

[INFO] Current profile set to default: yinzhang-mn1.linkedin.biz
HTTP/1.1 404 Not Found
Content-Type: text/plain;charset=utf-8
Date: Thu, 01 Mar 2018 21:40:48 GMT
x-ambry-error-code: NotFound
Content-Length: 0

#----------------------------------------------------------------------------------------------------------------------------#

7. GET blobInfo (in PROD)
[yinzhang@lva1-app18926 ~]$ curl -s -i -H "x-li-ambry-client:Internal" http://lva1-app18926.prod.linkedin.com:15158/AAMA______8AAQAAAAAAAAAAAAAAJDlkNGRlMTEzLTE5MWItNDA5MC05OGUzLTQ1ZWYzY2Y4MTE2ZQ.bin/BlobInfo

HTTP/1.1 404 Not Found
date: Fri, 16 Mar 2018 21:18:36 GMT
content-length: 0
x-ambry-error-code: NotFound
content-type: text/plain; charset=UTF-8

#----------------------------------------------------------------------------------------------------------------------------#

8. Bring down lva1-app6772.prod.linkedin.com which is one replica of partition 0 in prod-lva1:
lid-client control stop -f prod-lva1 -t ambry-server-main -H lva1-app6772.prod.linkedin.com AmbryLI

#----------------------------------------------------------------------------------------------------------------------------#

9. Bring down lca1-app1373.stg.linkedin.com which is one replica of partition 0 in ei-lca1:
lid-client control stop -f ei-lca1 -t ambry-server-main -H lca1-app1373.stg.linkedin.com AmbryLI

#----------------------------------------------------------------------------------------------------------------------------#

10. Bring back lva1-app6772.prod.linkedin.com:
[yinzhang@lva1-app18926 ~]$ lid-client control start -f prod-lva1 -t ambry-server-main -H lva1-app6772.prod.linkedin.com AmbryLI

#----------------------------------------------------------------------------------------------------------------------------#

11. Check Server status:

[yinzhang@lca1-app0680 ~]$ app-status -t ambry-server-main -f ei-lca1

ambry-server lca1-app1373.stg.linkedin.com i001 ambry-server-main 16.1.1 15151:GOOD  f76d7ea9-64ca-4eee-9a7b-1d98bfe18d48

12. check versions for mp
[yinzhang-mn1:~ yinzhang]$ mint describe oauth-filter

13. check the dependency for Multiproduct by ligradle.
[yinzhang-mn1:ambryli_trunk yinzhang]$ ligradle :ambry-impl:dependencyInsight --configuration compile --dependency depo-rest-api

14. git push ambryli-utils and ambryli_trunk override
    PCLOVERRIDE            # ambryli-utils
    PCVALIDATIONOVERRIDE   # ambryli_trunk
    
15. ssh eng-portal  # log into lca1-eng-portal02

16. [yinzhang@lca1-eng-portal02 ~]$ app-status -fg prod -t ambry-server-main --use-intended | grep -i CANARY  # check which servers are in canary

17. Hadoop SQL query (go/reportal, perform these queries)
    (1) use tracking;
        select blobUrn, blobProperties from AmbryOperationEvent 
        where datepartition >= '2017-12-01-00' and datepartition < '2018-01-31-00' and 
        blobProperties.appName = "gaap-online-tasks" and blobProperties.accountId != 209 and operationType = "PUT";
        
    (2) use tracking;
        select blobUrn, blobProperties from AmbryOperationEvent 
        where datepartition >= '2017-12-01-00' and datepartition < '2018-01-31-00' and 
        blobProperties.appName = "gaap-engine" and blobProperties.accountId != 315 and operationType = "PUT";
        
18. The log segments and indexing segments directory on production machine:
    [yinzhang@lca1-app1373 ambrydata]$ pwd
    /mnt/u001/ambrydata
    [yinzhang@lca1-app1373 ambrydata]$ ls 101/
    0_0_18_index  0_0_log  cleanuptoken  StoreDescriptor
    
19. The error log on production machine is located at: /export/content/lid/apps/ambry-server/i001/
    Example:
    [yinzhang@lca1-app1373 ambrydata]$ ls /export/content/lid/apps/ambry-server/i001/
    agents  appsConfig  bin  boot  components  conf  containerConfig  hooks  lib  logs  predeploy  resources  tmp  var  war  webapps
    [yinzhang@lca1-app1373 i001]$ cd logs/
    
#----------------------------------------------------------------------------------------------------------------------------#
20. deploy to qei:
    mint build && mint build-cfg --fabric qei-lca1 && mint deploy -a ambry-frontend --fabric qei-lca1 --skip-qei-routes --debug-app
 
21. deploy locally:
    mint build && mint build-cfg && mint release && mint release-cfg && mint deploy
    
#----------------------------------------------------------------------------------------------------------------------------#
22. upload to unencrypted container locally.
    [zemao@zemao-mn2]:~ $ curli -s -i --fabric ei-lca1 -H "x-ambry-target-account-name:ambryClientUnitTest" -H "x-ambry-target-container-name:container-a" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:ambry-test" -H "x-ambry-content-type:text" -H "x-ambry-um-description:static upload" -H "x-li-ambry-client:Internal" http://zemao-mn2.linkedin.biz:15158 --data-binary @1m.bin
    get BlobInfo.
    [zemao@zemao-mn2]:~ $ curl -i "http://zemao-mn2.linkedin.biz:15158/AAMAAQBoAAIAAQAAAAAAAAAAAAAAJGY4ZjllMThiLTI3YzctNGIwNy05Nzc5LTEyMTY1YWE3N2M0Yg.bin/BlobInfo" -H "x-li-ambry-client: Internal"
    HTTP/1.1 200 OK
    Date: Mon, 16 Apr 2018 19:10:19 GMT
    Last-Modified: Mon, 16 Apr 2018 19:09:47 GMT
    x-ambry-blob-size: 10
    x-ambry-service-id: CUrlUpload
    x-ambry-creation-time: Mon, 16 Apr 2018 19:09:47 GMT
    x-ambry-encrypted-in-storage: false
    x-ambry-content-type: text
    x-ambry-owner-id: ambry-test
    x-ambry-target-account-name: ambryClientUnitTest
    x-ambry-target-container-name: container-a
    x-ambry-private: false
    x-ambry-um-description: static upload
    Content-Length: 0
    
#----------------------------------------------------------------------------------------------------------------------------#
 23. upload to encrypted container locally.
     [zemao@zemao-mn2]:~ $ curli -s -i --fabric ei-lca1 -H "x-ambry-target-account-name:ambryClientUnitTest" -H "x-ambry-target-container-name:public-enc" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:ambry-test" -H "x-ambry-content-type:text" -H "x-ambry-um-description:static upload" -H "x-li-ambry-client:Internal" http://zemao-mn2.linkedin.biz:15158 --data-binary @1m.bin
     [zemao@zemao-mn2]:~ $ curl -i "http://zemao-mn2.linkedin.biz:15158/AAMAAQBoAAgAAQAAAAAAAAAAAAAAJGQxMWNmOWMxLWZmNWYtNDAxOC1hYmY1LTAzNmI1MzhkNWU4Yw.bin/BlobInfo" -H "x-li-ambry-client: Internal"
      HTTP/1.1 200 OK
      Date: Mon, 16 Apr 2018 19:07:56 GMT
      Last-Modified: Mon, 16 Apr 2018 19:06:26 GMT
      x-ambry-blob-size: 1048576
      x-ambry-service-id: CUrlUpload
      x-ambry-creation-time: Mon, 16 Apr 2018 19:06:26 GMT
      x-ambry-encrypted-in-storage: true
      x-ambry-content-type: text
      x-ambry-owner-id: ambry-test
      x-ambry-target-account-name: ambryClientUnitTest
      x-ambry-target-container-name: public-enc
      x-ambry-private: false
      x-ambry-um-description: static upload
      Content-Length: 0

[Conditional Delete Test]

// PUT a blob
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-ambry-target-container-name:container-a" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:yinzhang" -H "x-ambry-content-type:text/csv" -H "x-li-ambry-client:Internal" http://lva1-app8938.prod.linkedin.com:15158 --data-binary @test.csv
HTTP/1.1 201 Created
Location: /AAMAAgCAAAIAAQAAAAAAAAydAAAAJGFlNGEwMmEzLTAwNDYtNGQ1YS05ZmQ4LTE0YTJlNGM2ZWEwYw.csv
Date: Mon, 16 Apr 2018 20:46:33 GMT
Content-Length: 0
x-ambry-creation-time: Mon, 16 Apr 2018 20:46:32 GMT
Access-Control-Expose-Headers: Location

// DELETE a blob with incorrect account name
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:IncorrectCUrlTester" -H "x-ambry-target-container-name:container-a" -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAAAydAAAAJGFlNGEwMmEzLTAwNDYtNGQ1YS05ZmQ4LTE0YTJlNGM2ZWEwYw.csv
HTTP/1.1 412 Precondition Failed
date: Mon, 16 Apr 2018 20:50:04 GMT
content-length: 0
x-ambry-error-code: PreconditionFailed
content-type: text/plain; charset=UTF-8

// DELETE a blob with incorrect container name
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-ambry-target-container-name:container-b" -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAAAydAAAAJGFlNGEwMmEzLTAwNDYtNGQ1YS05ZmQ4LTE0YTJlNGM2ZWEwYw.csv
HTTP/1.1 412 Precondition Failed
date: Mon, 16 Apr 2018 20:50:52 GMT
content-length: 0
x-ambry-error-code: PreconditionFailed
content-type: text/plain; charset=UTF-8

// DELETE a blob with both correct account name and container name
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-ambry-target-container-name:container-a" -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAAAydAAAAJGFlNGEwMmEzLTAwNDYtNGQ1YS05ZmQ4LTE0YTJlNGM2ZWEwYw.csv
HTTP/1.1 202 Accepted
Date: Mon, 16 Apr 2018 20:51:14 GMT
Content-Length: 0

// PUT a blob again
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-ambry-target-container-name:container-a" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:yinzhang" -H "x-ambry-content-type:text/csv" -H "x-li-ambry-client:Internal" http://lva1-app8938.prod.linkedin.com:15158 --data-binary @test.csv
HTTP/1.1 201 Created
Location: /AAMAAgCAAAIAAQAAAAAAABFSAAAAJDllZGVjZWYzLTRkMTItNDFhMS05ZmNhLTBiNzk4ZWMzM2IzNQ.csv
Date: Mon, 16 Apr 2018 20:54:48 GMT
Content-Length: 0
x-ambry-creation-time: Mon, 16 Apr 2018 20:54:46 GMT
Access-Control-Expose-Headers: Location

//DELETE a blob with only container name specified
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-container-name:container-a" -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAABFSAAAAJDllZGVjZWYzLTRkMTItNDFhMS05ZmNhLTBiNzk4ZWMzM2IzNQ.csv
HTTP/1.1 400 Bad Request
date: Mon, 16 Apr 2018 20:56:57 GMT
content-length: 0
x-ambry-failure-reason: Only container name is set in request with no corresponding account name is not allowed.
x-ambry-error-code: BadRequest
content-type: text/plain; charset=UTF-8

// DELETE a blob with only correct account name
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAABFSAAAAJDllZGVjZWYzLTRkMTItNDFhMS05ZmNhLTBiNzk4ZWMzM2IzNQ.csv
HTTP/1.1 202 Accepted
Date: Mon, 16 Apr 2018 20:58:07 GMT
Content-Length: 0

// PUT the blob again
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-ambry-target-account-name:CUrlTester" -H "x-ambry-target-container-name:container-a" -H "x-ambry-service-id:CUrlUpload" -H "x-ambry-owner-id:yinzhang" -H "x-ambry-content-type:text/csv" -H "x-li-ambry-client:Internal" http://lva1-app8938.prod.linkedin.com:15158 --data-binary @test.csv
HTTP/1.1 201 Created
Location: /AAMAAgCAAAIAAQAAAAAAAAwgAAAAJDExMWNiNGE5LWM0ZWUtNDEwNy1iY2MwLThhY2VkNTlmYzIzNw.csv
Date: Mon, 16 Apr 2018 20:58:35 GMT
Content-Length: 0
x-ambry-creation-time: Mon, 16 Apr 2018 20:58:34 GMT
Access-Control-Expose-Headers: Location

// DELETE the blob with blobId only
[yinzhang@lva1-app8938 ~]$ curl -i -H "x-li-ambry-client:Internal" -X DELETE http://lva1-app8938.prod.linkedin.com:15158/ambry/AAMAAgCAAAIAAQAAAAAAAAwgAAAAJDExMWNiNGE5LWM0ZWUtNDEwNy1iY2MwLThhY2VkNTlmYzIzNw.csv
HTTP/1.1 202 Accepted
Date: Mon, 16 Apr 2018 20:59:51 GMT
Content-Length: 0
